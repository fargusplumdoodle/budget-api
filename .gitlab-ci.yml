image: docker:19.03.8

variables:
  DEBUG: "FALSE"
  SECRET_KEY: "SECRET_KEY"
  DEBIAN_FRONTEND: noninteractive
  CI_REGISTRY: hub.sekhnet.ra/budget-api
  CI: "TRUE"


stages:
  - build-dev
  - qa
  - build-feature
  - build-prod

build-dev:
  image: docker:19.03.8
  stage: build-dev
  script:
    - docker build -t "$CI_REGISTRY:$DEV_VERSION" -f Dockerfile-dev .
    - docker push "$CI_REGISTRY:$DEV_VERSION"

test:
  stage: qa
  image: "$CI_REGISTRY:$DEV_VERSION"
  script:
    - /venv/bin/python manage.py test

format:
  stage: qa
  image: "$CI_REGISTRY:$DEV_VERSION"
  script:
    - /venv/bin/black --check /code

flake8:
  stage: qa
  image: "$CI_REGISTRY:$DEV_VERSION"
  script:
    - /venv/bin/flake8 --config .flake8 /code

build-feature:
  image: docker:19.03.8
  stage: build-feature
  only:
    - /^.*feature$/
  script:
    - docker build -t "$CI_REGISTRY:$CI_COMMIT_REF_NAME" .
    - docker push "$CI_REGISTRY:$CI_COMMIT_REF_NAME"

build-prod:
  image: docker:19.03.8
  stage: build-prod
  only:
    - master
  script:
    - docker build -t "$CI_REGISTRY:latest" .
    - docker push "$CI_REGISTRY:latest"
