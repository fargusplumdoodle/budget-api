stages:
  - qa
  - build

variables:
  POSTGRES_DB: postgres
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DEBUG: "FALSE"
  SECRET_KEY: "SECRET_KEY"
  DEBIAN_FRONTEND: noninteractive
  IMAGE: hub.sekhnet.ra/budget-api
  CI: "TRUE"


default:
  image: python:3.9-slim
  services:
    - "postgres:latest"
  cache:
    paths:
      - ./venv/
  before_script:
    - ./scripts/install-ci.sh --dev


test:
  stage: qa
  variables:
    DB: postgres
    DB_HOST: postgres
    DB_USER: postgres
    DB_PASS: postgres
  script:
    - ./venv/bin/python manage.py test

migrations_check:
  stage: qa
  script:
    - ./venv/bin/python manage.py makemigrations --check

format:
  stage: qa
  script:
    - ./venv/bin/black --check .

flake8:
  stage: qa
  script:
    - ./venv/bin/flake8 --config .flake8 .

type_check:
  stage: qa
  script:
    - ./venv/bin/mypy --config-file .mypy .


build-dev:
  image: docker:19.03.8
  stage: build
  only:
    - dev
  before_script: []
  script:
    - docker build -t "$IMAGE:dev" .
    - docker push "$IMAGE:dev"

build-prod:
  image: docker:19.03.8
  stage: build
  before_script: []
  only:
    - main
  script:
    - docker build -t "$IMAGE:latest" .
    - docker push "$IMAGE:latest"
